<!DOCTYPE html>
<html>
	<head>

					<meta name="viewport" content="width=device-width, initial-scale=1">
	                <script src="/node_modules/jquery/dist/jquery.min.js"></script>
	                <script src="/node_modules/signature_pad/dist/signature_pad.umd.js"></script>
	                
	                <script src="/node_modules/vanilla-image-cropper/dist/rcrop.min.js"></script>
	                <link rel="stylesheet" href="/node_modules/vanilla-image-cropper/dist/rcrop.min.css">
	                
	                <link rel="stylesheet" href="/css/ui-bootstrap.css">
	              	
  

<style>
	body {
		font-family: Arial;
		margin: 0px;
	}
	#button-container{
		position: fixed;
		left: 0;
		bottom: 0;
	}
	.tab {
  		overflow: hidden;
  		border: 1px solid #ccc;
  		background-color: #f1f1f1;
	}
	.tab button {
		  background-color: inherit;
		  float: left;
		  border: none;
		  outline: none;
		  cursor: pointer;
		  padding: 14px 16px;
		  transition: 0.3s;
		  font-size: 17px;
		  text-decoration: underline;
	}
	.tab button:hover {
	  		background-color: #ddd;
	}
	.tab button.active {
	  		background-color: #ccc;
	}
	.tabcontent {
			height: 380px;
			border-left: 1px solid #ccc;
			border-right: 1px solid #ccc;
			border-bottom: 1px solid #ccc;
		  	display: none;
		  	padding: 5px;
		  	-webkit-animation: fadeEffect 1s;
		  	animation: fadeEffect 1s;
	}
	@-webkit-keyframes fadeEffect {
		  from {opacity: 0;}
		  to {opacity: 1;}
	}
	@keyframes fadeEffect {
		  from {opacity: 0;}
		  to {opacity: 1;}
	}

	#upload-image-editor,#draw-image-editor{
			border: 1px dotted #000000;
			text-align: center;
	}
	#draw-image-editor{
			background-color: #ddd;
			padding-top: 50px;
	}

	
	.wrapper {
			  position: relative;
			  width: 300px;
			  height: 100px;
			  -moz-user-select: none;
			  -webkit-user-select: none;
			  -ms-user-select: none;
			  user-select: none;
			  margin: auto;
			  border: 1px solid #000000;

	}
	.signature-pad {
			  position: absolute;
			  left: 0;
			  top: 0;
			  width:300px;
			  height:100px;
			  background-color: white;
	}
	.numbered-list {
        list-style: none;
        padding: 0;
        white-space: nowrap;
    }
    .numbered-list li {
        display: inline; /* Display list items inline */
        margin-right: 10px;
    }
    .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Three columns with equal width */
        gap: 5px; /* Gap between grid items */
        grid-auto-rows: 1fr;
        background-color: #ddd;
        padding: 5px;
    }
    .grid-item {
        background-color: #FFFFFF; /* Background color for grid items */
        padding: 10px; /* Padding inside grid items */
        text-align: center; /* Center-align content */
        position: relative;
    }
    .select-store-image {
       position: absolute;
	   bottom: 5%;
	   left: 50%;
	   transform: translateX(-50%);
	}
    @media only screen and (max-width:480px) { 
	 	.btn {
	            padding:10px;
	            font-size: x-large;
	    }
	}
</style>

</head>
<body >
<div class="tab">
	  <button class="tablinks" onclick="switchEditor(event, 'tabcontent-draw-image')"  id="defaultOpen">Draw</button>
	  <button class="tablinks" onclick="switchEditor(event, 'tabcontent-upload-image')">Upload</button>
	  <button class="tablinks" onclick="switchEditor(event, 'tabcontent-store-image')"  id="defaultOpen">Library</button>
	  
</div>
<div id="tabcontent-store-image" class="tabcontent"></div>
<div id="tabcontent-upload-image" class="tabcontent">
  	<input class="upload-file-input" accept="image/png, image/jpeg" type="file" style="display:none;">
  	<div id="upload-image-editor"></div>
  	<div class="button-container" style="text-align: center;">
		<button type="button" id="clear-image" class="btn btn-default">Clear</button>
		<button type="button" id="upload-image" class="btn btn-primary">Choose a file</button>
		<button type="button" id="copy-image" class="btn btn-success">Done</button>
	</div>
	<div>
		<div style="color:red;">
			Note: To create a signature image, it's best if the width is three times the height, like a rectangle that's 300 pixels wide and 100 pixels tall.
			You can choose a part of an image to make your signature. Think of it like cutting out a specific area from a larger picture.
			We'll make sure the background of your signature is white.
		</div>
	</div>
</div>
<div id="tabcontent-draw-image" class="tabcontent">
  	<div id="draw-image-editor">
  		<div class="wrapper">
  				<canvas id="signature-pad" class="signature-pad"></canvas>
		</div>
		
  	</div>
  	<div class="button-container" style="text-align: center;">
		<button type="button" id="clear-drawpad"  class="btn btn-default">Clear</button>
		<button type="button" id="copy-drawpad" class="btn btn-success ">Done</button>
  	</div>
  	<div style="color:red;">
  			Note:Please draw your signature at a normal pace, as if you were drawing on paper, for the best results.
  	</div>
  		
</div>
<script type="text/javascript">
	var URL = new URL(document.location);
	function switchEditor(evt, cityName) {
		  var i, tabcontent, tablinks;
		  tabcontent = document.getElementsByClassName("tabcontent");
		  for (i = 0; i < tabcontent.length; i++) {
		    tabcontent[i].style.display = "none";
		  }
		  tablinks = document.getElementsByClassName("tablinks");
		  for (i = 0; i < tablinks.length; i++) {
		    tablinks[i].className = tablinks[i].className.replace(" active", "");
		  }
		  document.getElementById(cityName).style.display = "block";
		  evt.currentTarget.className += " active";
	}

	function cropImageFromCanvas(imageObject, cropArea, filter) {
		  var filter=filter.toLowerCase(); console.log(filter);
		  var canvas = document.createElement('canvas');
		  var ctx = null;
		  if(jQuery.isPlainObject(cropArea)){
		  	 canvas.setAttribute("width", cropArea.width);
			 canvas.setAttribute("height", cropArea.height);
			 ctx = canvas.getContext('2d');
		     ctx.drawImage(imageObject, cropArea.x, cropArea.y, cropArea.width, cropArea.height, 0, 0, cropArea.width, cropArea.height);
		  }else{
			  canvas.setAttribute("width", imageObject.width);
			  canvas.setAttribute("height", imageObject.height);
			  ctx = canvas.getContext('2d');
		      ctx.drawImage(imageObject, 0, 0);
		  }
		  var w = canvas.width;
		  var h = canvas.height;
		  var pix = {x:[], y:[]};
		  var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
		  var x=0,y=0,index=0;
		  
		  if(URL.searchParams.get("uitype")=="signature"){
			  for (y = 0; y < h; y++) {
			    for (x = 0; x < w; x++) {
			      index = (y * w + x) * 4;
			      	if(filter=='high'){
				      	if(imageData.data[index+0] > 100 && imageData.data[index+1] > 100 && imageData.data[index+2] > 100){
				      		imageData.data[index+0]=255;
				      		imageData.data[index+1]=255;
				      		imageData.data[index+2]=255;
				      	}
				    }else if(filter=='low'){
				    	if(imageData.data[index+0] > 225 && imageData.data[index+1] > 225 && imageData.data[index+2] > 225){
				      		imageData.data[index+0]=255;
				      		imageData.data[index+1]=255;
				      		imageData.data[index+2]=255;
				      	}
				    }
			    }
			  }
		  }

		  ctx.putImageData(imageData,0,0);
		  var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
		  var x=0,y=0,index=0;
		  for (y = 0; y < h; y++) {
		    for (x = 0; x < w; x++) {
		      index = (y * w + x) * 4;
		      if (imageData.data[index+3] > 0) {
		        pix.x.push(x);
		        pix.y.push(y);
		      } 
		    }
		  }
		  pix.x.sort(function(a,b){return a-b});
		  pix.y.sort(function(a,b){return a-b});
		  var n = pix.x.length-1;

		  w = 1 + pix.x[n] - pix.x[0];
		  h = 1 + pix.y[n] - pix.y[0];
		  var cut = ctx.getImageData(pix.x[0], pix.y[0], w, h);
		  canvas.width = w;
		  canvas.height = h;
		  ctx.putImageData(cut, 0, 0);
		  var payload={"image":canvas.toDataURL('image/png'),"width":canvas.width,"height":canvas.height};
		  canvas.remove();
		  return payload;
	}
	
	function removeImageBlanks(imageObject) {
		var imgWidth = imageObject.width;
	    var imgHeight = imageObject.height;
	    var canvas = document.createElement('canvas');
	    canvas.setAttribute("width", imgWidth);
	    canvas.setAttribute("height", imgHeight);
	    var context = canvas.getContext('2d');
	    context.drawImage(imageObject, 0, 0);

	    var imageData = context.getImageData(0, 0, imgWidth, imgHeight),
	        data = imageData.data,
	    getRBG = function(x, y) {
	            var offset = imgWidth * y + x;
	            return {
	                red:     data[offset * 4],
	                green:   data[offset * 4 + 1],
	                blue:    data[offset * 4 + 2],
	                opacity: data[offset * 4 + 3]
	            };
	    },
	    isWhite = function (rgb) {
	            // many images contain noise, as the white is not a pure #fff white
	            return rgb.red > 200 && rgb.green > 200 && rgb.blue > 200;
	    },
	    scanY = function (fromTop) {
	        var offset = fromTop ? 1 : -1;

	        // loop through each row
	        for(var y = fromTop ? 0 : imgHeight - 1; fromTop ? (y < imgHeight) : (y > -1); y += offset) {

	            // loop through each column
	            for(var x = 0; x < imgWidth; x++) {
	                var rgb = getRBG(x, y);
	                if (!isWhite(rgb)) {
	                    if (fromTop) {
	                        return y;
	                    } else {
	                        return Math.min(y + 1, imgHeight);
	                    }
	                }
	            }
	        }
	        return null; // all image is white
	    },
	    scanX = function (fromLeft) {
	        var offset = fromLeft? 1 : -1;

	        // loop through each column
	        for(var x = fromLeft ? 0 : imgWidth - 1; fromLeft ? (x < imgWidth) : (x > -1); x += offset) {

	            // loop through each row
	            for(var y = 0; y < imgHeight; y++) {
	                var rgb = getRBG(x, y);
	                if (!isWhite(rgb)) {
	                    if (fromLeft) {
	                        return x;
	                    } else {
	                        return Math.min(x + 1, imgWidth);
	                    }
	                }      
	            }
	        }
	        return null; // all image is white
	    };
	    var cropTop = scanY(true),
	        cropBottom = scanY(false),
	        cropLeft = scanX(true),
	        cropRight = scanX(false),
	        cropWidth = cropRight - cropLeft,
	        cropHeight = cropBottom - cropTop;

	    canvas.setAttribute("width", cropWidth);
	    canvas.setAttribute("height", cropHeight);
	    canvas.getContext("2d").drawImage(imageObject,cropLeft, cropTop, cropWidth, cropHeight,0, 0, cropWidth, cropHeight);

	    var payload={"image":canvas.toDataURL(),"width":canvas.width,"height":canvas.height};
	    canvas.remove();
	    return payload;
	}

	function bestFitImage(containerWidth, containerHeight, imageWidth, imageHeight) {

		if(imageWidth > containerWidth){
        	var ratio=(imageHeight / imageWidth);
        	imageWidth=containerWidth;
        	imageHeight=imageWidth*ratio;
        }
        
        if(imageHeight > containerHeight){
        	var ratio=(imageWidth / imageHeight);
        	imageHeight=containerHeight;
        	imageWidth=imageHeight*ratio;
        }
	    return { width: imageWidth, height: imageHeight };
	}

	var imageCropper=false;
	var signaturePad=false;
	
	/*
	if(URL.searchParams.get("uitype")=="picture"){
		jQuery('#sign-area').html('Draw your image here.');
	}else{
		jQuery('#sign-area').html('Sign in following area.');
	}*/

	jQuery(document).ready(function($){
		var dialogWidth=URL.searchParams.get("width");
		var dialogHeight=URL.searchParams.get("height");
		
		var tabHeight=50;
		jQuery('.tab').css('height',tabHeight);
		jQuery('.tabcontent').css('height',dialogHeight-tabHeight-150);

		
		var uploadImageEditorWidth=dialogWidth-(dialogWidth/100)*1;
		var uploadImageEditorHeight=dialogHeight-tabHeight-150;

		var drawImageEditorWidth=uploadImageEditorWidth*0.9;
		var drawImageEditorHeight=uploadImageEditorHeight;
		if((drawImageEditorWidth/3) <= drawImageEditorHeight){
			drawImageEditorHeight=drawImageEditorWidth/3;
		}else{
			drawImageEditorWidth=drawImageEditorHeight*3;
		}
		

		var imagestorecounter=parseInt(localStorage.getItem("imagestorecounter"));
		if(isNaN(imagestorecounter)){
			imagestorecounter=1;
		}
		jQuery('#tabcontent-store-image').append('<div id="tabcontent-store-image-list" class="grid-container"></div>');
		var imagecounterIndex=1;
		for(var imagecounter=imagestorecounter;imagecounter > 0 ; imagecounter-- ){
			var payload=localStorage.getItem("imagestore-"+imagecounter);
			if(payload != null){
				if(imagecounterIndex < 10){
					payload=JSON.parse(payload);
					var image = new Image(200);
					image.src = payload["image"];

					jQuery('#tabcontent-store-image-list')
					.append('<div class="grid-item"></div>')
					.find('.grid-item:last')
					.append(image)
					.append('<br/><button class="select-store-image btn btn-success" data-imagestore="imagestore-'+imagecounter+'">Select</button>');
					imagecounterIndex++;
				}else{
					localStorage.removeItem("imagestore-"+imagecounter)
				}
			}
		}


		jQuery('#upload-image-editor')
		.css({'width':uploadImageEditorWidth+'px','height':uploadImageEditorHeight+'px'});

		jQuery('#draw-image-editor')
		.css({'width':uploadImageEditorWidth+'px'});//,'height':(uploadImageEditorHeight)+'px'

		jQuery('.wrapper,#signature-pad')
		.css({'width':drawImageEditorWidth+'px','height':drawImageEditorHeight+'px'});

		
		jQuery('#upload-image').click(function(){
				var $this=jQuery(this);
				jQuery('.upload-file-input').trigger('click');
		});

		jQuery('#clear-image').click(function(e){
				if(imageCropper!== false){
					imageCropper.rcrop('destroy');
					imageCropper=false;
				}
		});

		jQuery('.select-store-image').click(function(e){
				var imagestore=jQuery(this).data('imagestore');
				payload=localStorage.getItem(imagestore);
				window.parent.postMessage(payload,"*");
		});

		
		
		jQuery('#copy-image').click(function(e){
				cropArea=imageCropper.rcrop('getValues');
				var payload = cropImageFromCanvas(jQuery('#image-pad').get(0),cropArea, 'high');
					payload["autofit"]=1;
					payload=JSON.stringify(payload);
					var imagestorecounter=parseInt(localStorage.getItem("imagestorecounter"));
					if(isNaN(imagestorecounter)){
						imagestorecounter=1;
					}
					imagestorecounter++;
					localStorage.setItem("imagestore-"+imagestorecounter, payload);
					localStorage.setItem("imagestorecounter",imagestorecounter);
					window.parent.postMessage(payload,"*");			
		});
		
		jQuery('.upload-file-input').change(function(e){
						const reader = new FileReader();
				        reader.onload = e => {
				        	
				        	var image = new Image();
						    image.src = e.target.result;
						    image.id = "image-pad";
						    image.onload = function() {
						    	
						    	console.log({
						    		"uploadImageEditorWidth":uploadImageEditorWidth, 
						    		"uploadImageEditorHeight":uploadImageEditorHeight, 
						    		"width":this.width, 
						    		"height":this.height
						    	});

						    	var dimensions = bestFitImage(uploadImageEditorWidth, uploadImageEditorHeight, this.width, this.height,image);
						    	this.style.width=dimensions.width+'px';
						    	this.style.height=dimensions.height+'px';						    	
						    	jQuery("#upload-image-editor").html(image);

						    	

						    	if(URL.searchParams.get("uitype")=="picture"){
					        		imageCropper=jQuery('#image-pad').rcrop({
									    minSize : [200,200],
									    preserveAspectRatio : true,
										grid : false
									});
					        	}else{
					        		imageCropper=jQuery('#image-pad').rcrop({
									    minSize : [120,40],
									    preserveAspectRatio : true,
										grid : false
									});
					        	}
						        
						    };

				        	//jQuery("#upload-image-editor")
				        	//.html('<img style="object-fit:scale-down" id="image-pad" src="'+e.target.result+'">');

				        	
				        };
				        reader.readAsDataURL(e.target.files[0]);
		});

	
			var textColor = URL.searchParams.get("textcolor");
			if(URL.searchParams.get("uitype")=="picture"){
				signaturePad = new SignaturePad(document.getElementById('signature-pad'), {
			  		"backgroundColor": "rgb(255, 255, 255)",
			  		"width": "200px",
	            	"height": "200px",
	            	"penColor": textColor
				});	
			}else{
				signaturePad = new SignaturePad(document.getElementById('signature-pad'), {
			  		"backgroundColor": "rgb(255, 255, 255)",
			  		"width": drawImageEditorWidth+"px",
	            	"height": drawImageEditorHeight+"px",
	            	"penColor": textColor
				});	
			}	
			
			signaturePad.clear();	
			jQuery('#clear-drawpad').click(function(e){
				if(signaturePad!==false){
			  		signaturePad.clear();
				}
			});
			jQuery('#copy-drawpad').click(function(e){
				if(signaturePad!==false){
					var payload={};
					var myImage = new Image();
					myImage.crossOrigin = "Anonymous";
					myImage.onload = function(){
						var payload = cropImageFromCanvas(myImage,false,'low'); 
						payload["autofit"]=1;
						payload=JSON.stringify(payload);
						
						var imagestorecounter=parseInt(localStorage.getItem("imagestorecounter"));
						if(isNaN(imagestorecounter)){
							imagestorecounter=1;
						}
						imagestorecounter++;
						localStorage.setItem("imagestore-"+imagestorecounter, payload);
						localStorage.setItem("imagestorecounter",imagestorecounter);

						window.parent.postMessage(payload,"*");
						myImage.remove();
					}
					myImage.src = signaturePad.toDataURL('image/png');

				}
			});
			function resizeCanvas() {
				var canvas = document.getElementById('signature-pad');
				if(canvas){
				    var ratio =  Math.max(window.devicePixelRatio || 1, 1);
					    canvas.width = canvas.offsetWidth * ratio;
					    canvas.height = canvas.offsetHeight * ratio;
					    canvas.getContext("2d").scale(ratio, ratio);
				}
			}
			window.onresize = resizeCanvas;
			resizeCanvas();		
	});

	document.getElementById("defaultOpen").click();	
</script>



</body>
</html>
